<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta charset="utf-8" />
		<link rel="stylesheet" type="text/css" href="css/style.css" />
		<title>Firebase과 Swift 연동 2</title>
	</head>
<body>
<h1>Firebase과 Swift 연동 2</h1>

<h3>스토리지 </h3>

<p>Cloud Storage는 사진, 동영상 등의 사용자 제작 콘텐츠를 저장하고 제공해야 하는 앱 개발자를 위해 만들어졌습니다. 단순하며 경제적인 저장소 입니다. 이 Storge를 사용하여 이미지, 오디오, 동영상 등의 사용자 제작 콘텐츠를 저장할 수 있습니다.</p>

<h4>스토리지 사용 설정</h4>

<ol>
	<li>파이어베이스 콘솔로 이동하자</li>
</ol>

<p><a href="https://console.firebase.google.com/u/0/">https://console.firebase.google.com</a>이동 후 <strong>HowlTalk</strong>프로젝트로 이동하자</p>

<ol start="2">
	<li>스토리지를 만들자</li>
</ol>

<figure><img src="Screen%20Shot%202019-11-08%20at%202.41.40%20AM.png"/></figure>

<ol start="3">
	<li><strong>구칙</strong>로 설정 후 다음으로 넘어가자</li>
</ol>

<figure><img src="Screen%20Shot%202019-11-08%20at%202.41.58%20AM.png"/></figure>

<ol start="4">
	<li>지역을 asia-northesat(동북아시아)로 설정하자</li>
</ol>

<figure><img src="Screen%20Shot%202019-11-08%20at%202.42.24%20AM.png"/></figure>

<h4>스토리지 파일 업로드</h4>

<p>업로드 방법은 <strong>putData</strong>코드로 로 업로드 하시면 됩니다. 이전 버전과 많이 달라진 점은 다운로드 완료 후 <strong>DownloadUrl</strong> 주소를 받아 올때 <strong>Reference</strong>에서 <strong>downloadURL</strong> 코드를 넣어서 호출 해야됩니다.</p>

<pre><code class="code-highlighted code-swift"><span class="syntax-all syntax-comment">// 이미지를 Data 방식으로 메모리에 저장한 부분
</span><span class="syntax-all syntax-keyword">let</span> data <span class="syntax-all syntax-keyword">=</span> <span class="syntax-all syntax-constant">Data</span>()

<span class="syntax-all syntax-comment">// 이미지를 저장할 경로
</span><span class="syntax-all syntax-keyword">let</span> riversRef <span class="syntax-all syntax-keyword">=</span> storageRef.<span class="syntax-all syntax-constant">child</span>(<span class="syntax-all syntax-string">&quot;images&quot;</span>).<span class="syntax-all syntax-constant">child</span>(<span class="syntax-all syntax-string">&quot;rivers.jpg&quot;</span>)

<span class="syntax-all syntax-comment">// 이미지 업로드 코드
</span>riversRef.<span class="syntax-all syntax-constant">putData</span>(data, <span class="syntax-all syntax-constant">metadata</span>: <span class="syntax-all syntax-constant">nil</span>) { (metadata, error) <span class="syntax-all syntax-keyword">in</span>

  <span class="syntax-all syntax-comment">// 이미지 업로드 후 이미지 URL 주소 받는 코드
</span>  riversRef.<span class="syntax-all syntax-parameter">downloadURL</span> { (url, error) <span class="syntax-all syntax-keyword">in</span>
    <span class="syntax-all syntax-constant">print</span>(url)
  }
}    </code></pre>

<ul>
	<li>상세설명</li>
</ul>

<h5>파일 경로</h5>

<pre><code class="code-highlighted code-swift">storageRef.<span class="syntax-all syntax-constant">child</span>(<span class="syntax-all syntax-string">&quot;images&quot;</span>).<span class="syntax-all syntax-constant">child</span>(<span class="syntax-all syntax-string">&quot;rivers.jpg&quot;</span>)</code></pre>

<p>여기서 child는 데이터베이스와 같은 하위 경로는 나타내는 부분이라고 보면된다.</p>

<h5>다운로드 경로</h5>

<pre><code class="code-highlighted code-swift"><span class="syntax-all syntax-comment">// 이미지를 저장할 경로
</span><span class="syntax-all syntax-keyword">let</span> riversRef <span class="syntax-all syntax-keyword">=</span> storageRef.<span class="syntax-all syntax-constant">child</span>(<span class="syntax-all syntax-string">&quot;images&quot;</span>).<span class="syntax-all syntax-constant">child</span>(<span class="syntax-all syntax-string">&quot;rivers.jpg&quot;</span>)
riversRef.<span class="syntax-all syntax-parameter">downloadURL</span> { (url, error) <span class="syntax-all syntax-keyword">in</span>
    <span class="syntax-all syntax-constant">print</span>(url)
}</code></pre>

<p>다운로드 경로는 실제적으로 파일 경로를 지정해주어야 다운로드 경로를 받아 올 수 있다.</p>

<h5>실습하기 - 사진올리기</h5>

<ol>
	<li>먼저 Info.plist에 <strong>Privacy - Photo Library Usage Description</strong>권한을 추가해주자.</li>
</ol>

<figure><img src="DraggedImage.tiff"/></figure>

<ol start="2">
	<li>Interface Builder 디자인을 만들어주자.</li>
</ol>

<figure><img src="Screen%20Shot%202019-11-08%20at%204.00.22%20AM.png"/></figure>

<ol start="3">
	<li>앨범 오픈 코드를 넣어주자.</li>
</ol>

<ul>
	<li>앨범 오픈 코드</li>
</ul>

<pre><code class="code-highlighted code-swift"><span class="syntax-all syntax-comment">//UIImagePickerController선언
</span><span class="syntax-all syntax-keyword">let</span> pickerController <span class="syntax-all syntax-keyword">=</span> <span class="syntax-all syntax-constant">UIImagePickerController</span>()
<span class="syntax-all syntax-comment">//인터페이스 연결(사진선택, 취소)
</span>pickerController.<span class="syntax-all syntax-parameter">delegate</span> <span class="syntax-all syntax-keyword">=</span> <span class="syntax-all syntax-constant">self</span>
<span class="syntax-all syntax-comment">//소스타입 앨범선택 (카메라, 앨범)
</span>pickerController.<span class="syntax-all syntax-parameter">sourceType</span> <span class="syntax-all syntax-keyword">=</span> .<span class="syntax-all syntax-constant">photoLibrary</span>
<span class="syntax-all syntax-comment">//화면띄우기
</span><span class="syntax-all syntax-constant">present</span>(pickerController, <span class="syntax-all syntax-constant">animated</span>: <span class="syntax-all syntax-constant">true</span>, <span class="syntax-all syntax-constant">completion</span>: <span class="syntax-all syntax-constant">nil</span>)</code></pre>

<p>따로 설명할 필요 없이 간결한 것을 볼 수 있으며 참고로 Delegate를 연결해주기 위해서는 인터페이스 코드를 추가해줘야한다.</p>

<pre><code class="code-highlighted code-swift"><span class="syntax-all syntax-keyword">class</span> <span class="syntax-all syntax-entity">ViewController</span>: UIViewController, UIImagePickerControllerDelegate, UINavigationControllerDelegate </code></pre>

<ul>
	<li>사진 선택 후 호출되는 코드</li>
</ul>

<pre><code class="code-highlighted code-swift"><span class="syntax-all syntax-keyword">func</span> <span class="syntax-all syntax-entity">imagePickerController</span>(<span class="syntax-all syntax-entity">_</span> <span class="syntax-all syntax-parameter">picker</span>: UIImagePickerController, <span class="syntax-all syntax-entity">didFinishPickingMediaWithInfo</span> <span class="syntax-all syntax-parameter">info</span>: [UIImagePickerController.InfoKey : <span class="syntax-all syntax-constant">Any</span>]) {
        <span class="syntax-all syntax-keyword">var</span> image <span class="syntax-all syntax-keyword">=</span> info[.<span class="syntax-all syntax-parameter">originalImage</span>] <span class="syntax-all syntax-keyword">as?</span> UIImage
}</code></pre>

<ul>
	<li>전체코드</li>
</ul>

<pre><code class="code-highlighted code-swift"><span class="syntax-all syntax-keyword">import</span> <span class="syntax-all syntax-entity">UIKit</span>
<span class="syntax-all syntax-keyword">import</span> <span class="syntax-all syntax-entity">Firebase</span>
<span class="syntax-all syntax-keyword">import</span> <span class="syntax-all syntax-entity">FirebaseDatabase</span>
<span class="syntax-all syntax-keyword">class</span> <span class="syntax-all syntax-entity">ViewController</span>: UIViewController, UIImagePickerControllerDelegate, UINavigationControllerDelegate {
    <span class="syntax-all syntax-keyword">@IBOutlet</span> <span class="syntax-all syntax-keyword">weak</span> <span class="syntax-all syntax-keyword">var</span> mainImageview<span class="syntax-all syntax-keyword">:</span> UIImageView<span class="syntax-all syntax-keyword">!</span>
    <span class="syntax-all syntax-keyword">@IBOutlet</span> <span class="syntax-all syntax-keyword">weak</span> <span class="syntax-all syntax-keyword">var</span> albumButton<span class="syntax-all syntax-keyword">:</span> UIButton<span class="syntax-all syntax-keyword">!</span>
    
    <span class="syntax-all syntax-keyword">override</span> <span class="syntax-all syntax-keyword">func</span> <span class="syntax-all syntax-entity">viewDidLoad</span>() {
        <span class="syntax-all syntax-constant">super</span>.<span class="syntax-all syntax-constant">viewDidLoad</span>()
        albumButton.<span class="syntax-all syntax-constant">addTarget</span>(<span class="syntax-all syntax-constant">self</span>, <span class="syntax-all syntax-constant">action</span>: <span class="syntax-all syntax-constant">#selector</span>(actionSelectImage), <span class="syntax-all syntax-constant">for</span>: UIControl.<span class="syntax-all syntax-parameter">Event</span>.<span class="syntax-all syntax-parameter">touchUpInside</span>)
    }
    <span class="syntax-all syntax-keyword">@objc</span> <span class="syntax-all syntax-keyword">func</span> <span class="syntax-all syntax-entity">actionSelectImage</span>(){
        <span class="syntax-all syntax-keyword">let</span> pickerController <span class="syntax-all syntax-keyword">=</span> <span class="syntax-all syntax-constant">UIImagePickerController</span>()
        pickerController.<span class="syntax-all syntax-parameter">delegate</span> <span class="syntax-all syntax-keyword">=</span> <span class="syntax-all syntax-constant">self</span>
        pickerController.<span class="syntax-all syntax-parameter">sourceType</span> <span class="syntax-all syntax-keyword">=</span> .<span class="syntax-all syntax-constant">photoLibrary</span>
        <span class="syntax-all syntax-constant">present</span>(pickerController, <span class="syntax-all syntax-constant">animated</span>: <span class="syntax-all syntax-constant">true</span>, <span class="syntax-all syntax-constant">completion</span>: <span class="syntax-all syntax-constant">nil</span>)
    }
	
	<span class="syntax-all syntax-keyword">func</span> <span class="syntax-all syntax-entity">imagePickerController</span>(<span class="syntax-all syntax-entity">_</span> <span class="syntax-all syntax-parameter">picker</span>: UIImagePickerController, <span class="syntax-all syntax-entity">didFinishPickingMediaWithInfo</span> <span class="syntax-all syntax-parameter">info</span>: [UIImagePickerController.InfoKey : <span class="syntax-all syntax-constant">Any</span>]) {
		<span class="syntax-all syntax-constant">dismiss</span>(<span class="syntax-all syntax-constant">animated</span>: <span class="syntax-all syntax-constant">true</span>, <span class="syntax-all syntax-constant">completion</span>: <span class="syntax-all syntax-constant">nil</span>)
        <span class="syntax-all syntax-keyword">var</span> image <span class="syntax-all syntax-keyword">=</span> info[.<span class="syntax-all syntax-parameter">originalImage</span>] <span class="syntax-all syntax-keyword">as?</span> UIImage
		mainImageview.<span class="syntax-all syntax-constant">image</span> <span class="syntax-all syntax-keyword">=</span> image
	}
    
}</code></pre>

<ol start="4">
	<li>이미지 업로드 코드를 넣어주자.</li>
</ol>

<pre><code class="code-highlighted code-swift"><span class="syntax-all syntax-keyword">func</span> <span class="syntax-all syntax-entity">imagePickerController</span>(<span class="syntax-all syntax-entity">_</span> <span class="syntax-all syntax-parameter">picker</span>: UIImagePickerController, <span class="syntax-all syntax-entity">didFinishPickingMediaWithInfo</span> <span class="syntax-all syntax-parameter">info</span>: [UIImagePickerController.InfoKey : <span class="syntax-all syntax-constant">Any</span>]) {
    <span class="syntax-all syntax-constant">dismiss</span>(<span class="syntax-all syntax-constant">animated</span>: <span class="syntax-all syntax-constant">true</span>, <span class="syntax-all syntax-constant">completion</span>: <span class="syntax-all syntax-constant">nil</span>)
    <span class="syntax-all syntax-keyword">var</span> image <span class="syntax-all syntax-keyword">=</span> info[.<span class="syntax-all syntax-parameter">originalImage</span>] <span class="syntax-all syntax-keyword">as?</span> UIImage
    <span class="syntax-all syntax-comment">//사진 용량이 크기때문에 10분 1로 줄여주자.
</span>    <span class="syntax-all syntax-keyword">let</span> data <span class="syntax-all syntax-keyword">=</span> image<span class="syntax-all syntax-keyword">?</span>.<span class="syntax-all syntax-constant">jpegData</span>(<span class="syntax-all syntax-constant">compressionQuality</span>: <span class="syntax-all syntax-constant">0.1</span>)
    <span class="syntax-all syntax-comment">// 이미지를 저장할 경로
</span>    <span class="syntax-all syntax-keyword">let</span> riversRef <span class="syntax-all syntax-keyword">=</span>  <span class="syntax-all syntax-constant">Storage</span>.<span class="syntax-all syntax-constant">storage</span>().<span class="syntax-all syntax-constant">reference</span>().<span class="syntax-all syntax-constant">child</span>(<span class="syntax-all syntax-string">&quot;images&quot;</span>).<span class="syntax-all syntax-constant">child</span>(<span class="syntax-all syntax-string">&quot;rivers.jpg&quot;</span>)
    <span class="syntax-all syntax-comment">// 이미지 업로드 코드
</span>    riversRef.<span class="syntax-all syntax-constant">putData</span>(data<span class="syntax-all syntax-keyword">!</span>, <span class="syntax-all syntax-constant">metadata</span>: <span class="syntax-all syntax-constant">nil</span>) { (metadata, error) <span class="syntax-all syntax-keyword">in</span>
      <span class="syntax-all syntax-comment">// 이미지 업로드 후 이미지 URL 주소 받는 코드
</span>      riversRef.<span class="syntax-all syntax-parameter">downloadURL</span> { (url, error) <span class="syntax-all syntax-keyword">in</span>
        <span class="syntax-all syntax-constant">print</span>(url)
      }
    }
}</code></pre>

<ul>
	<li>Log 메세지</li>
</ul>

<pre><code class="code-highlighted code-swift"><span class="syntax-all syntax-constant">Optional</span>(<span class="syntax-all syntax-constant">https</span>:<span class="syntax-all syntax-comment">//firebasestorage.googleapis.com/v0/b/howltalk-d92b6.appspot.com/o/images%2Frivers.jpg?alt=media&amp;token=03eede17-6a16-4d1d-8ea1-f5a896b2b4a1)
</span></code></pre>

<ul>
	<li>Firebase Console</li>
</ul>

<figure><img src="DraggedImage-1.tiff"/></figure>

<h4>사진 다운로드</h4>

<p>스토리지로 파일을 직접 코드로 아래와같이 파일을 다운로드를 받지 않는다. </p>

<p>그 이유는 파일 경로가 드러나게 될 경우 앱에 대한 보안 이슈가 발생하기 때문에 거의 사용하지 않는다.</p>

<pre><code class="code-highlighted code-swift"><span class="syntax-all syntax-keyword">let</span> islandRef <span class="syntax-all syntax-keyword">=</span> storageRef.<span class="syntax-all syntax-constant">child</span>(<span class="syntax-all syntax-string">&quot;images/island.jpg&quot;</span>)
islandRef.<span class="syntax-all syntax-constant">getData</span>(<span class="syntax-all syntax-constant">maxSize</span>: <span class="syntax-all syntax-constant">1</span> <span class="syntax-all syntax-keyword">*</span> <span class="syntax-all syntax-constant">1024</span> <span class="syntax-all syntax-keyword">*</span> <span class="syntax-all syntax-constant">1024</span>)</code></pre>

<p>보통은 <strong>DownloadUrl</strong> 주소를 <strong>Database</strong>에 저장해서 필요할때 불러오는 것이 일반적인 방법이다.</p>

<h5>이미지 다운로더 라이브러리 설치</h5>

<p>보통 이미지를 다운 받기위해서는 많은 스레드 처리가 필요하다. 능숙한 개발자라도 이미지 쓰레드 처리는 쉽지 않기 때문에 이미지 다운로드 같은 경우 전문 Dependency(라이브러리)를 통해서 처리를 한다.</p>

<ol>
	<li>Podfile에 SDWebImage 추가하기</li>
</ol>

<figure><img src="Screen%20Shot%202019-11-04%20at%209.37.05%20PM.png"/><img src="Screen%20Shot%202019-11-07%20at%206.46.02%20PM.png"/></figure>

<p>위에 프로젝트 경로 이동한 후 아래 명령어를 입력하게되면</p>

<p>위에 프로젝트 경로 이동한 후 아래 명령어를 입력하게되면</p>

<pre><code class="code-highlighted code-bash">open Podfile</code></pre>

<p>테스트 파일이 열리며 </p>

<pre><code class="code-highlighted code-bash"><span class="syntax-all syntax-comment"># Uncomment the next line to define a global platform for your project
</span><span class="syntax-all syntax-comment"># platform :ios, &#39;9.0&#39;
</span>
target <span class="syntax-all syntax-string">&#39;HowlTalk&#39;</span> <span class="syntax-all syntax-keyword">do</span>
  <span class="syntax-all syntax-comment"># Comment the next line if you don&#39;t want to use dynamic frameworks
</span>  use_frameworks<span class="syntax-all syntax-keyword">!</span>

  <span class="syntax-all syntax-comment"># Pods for HowlTalk
</span>
<span class="syntax-all syntax-comment">#파이어베이스 라이브러리 추가
</span>  pod <span class="syntax-all syntax-string">&#39;Firebase/Analytics&#39;</span>
  pod <span class="syntax-all syntax-string">&#39;Firebase/Auth&#39;</span>
  pod <span class="syntax-all syntax-string">&#39;Firebase/Database&#39;</span>
  pod <span class="syntax-all syntax-string">&#39;SDWebImage&#39;</span>

  target <span class="syntax-all syntax-string">&#39;HowlTalkTests&#39;</span> <span class="syntax-all syntax-keyword">do</span>
    inherit<span class="syntax-all syntax-keyword">!</span> :search_paths
    <span class="syntax-all syntax-comment"># Pods for testing
</span>  end

  target <span class="syntax-all syntax-string">&#39;HowlTalkUITests&#39;</span> <span class="syntax-all syntax-keyword">do</span>
    <span class="syntax-all syntax-comment"># Pods for testing
</span>  end

end</code></pre>

<p>SDWebImage 추가한 후에 Install를 해주자.</p>

<pre><code class="code-highlighted code-bash">pod install</code></pre>

<h5>URL 주소로 사진 다운로드</h5>

<p>사진을 다운로드 하는 방법은 이미지 뷰에 <strong>sd_setImage</strong>호출 하면된다.</p>

<pre><code class="code-highlighted code-swift"><span class="syntax-all syntax-keyword">import</span> <span class="syntax-all syntax-entity">SDWebImage</span>

mainImageview.<span class="syntax-all syntax-constant">sd_setImage</span>(<span class="syntax-all syntax-constant">with</span>: <span class="syntax-all syntax-constant">URL</span>(<span class="syntax-all syntax-constant">string</span>: <span class="syntax-all syntax-string">&quot;이미지 주소&quot;</span>), <span class="syntax-all syntax-constant">completed</span>: <span class="syntax-all syntax-constant">nil</span>)</code></pre>

<ol>
	<li>URL 이미지 주소 가져오기</li>
</ol>

<figure><img src="Screen%20Shot%202019-11-08%20at%204.28.47%20AM.png"/></figure>

<p>복사해서 붙혀넣으면 이미지 주소가 추출 이렇게 추출된다.</p>

<pre><code class="code-highlighted code-bash">https://firebasestorage.googleapis.com/v0/b/howltalk-d92b6.appspot.com/o/images%2Frivers.jpg<span class="syntax-all syntax-keyword">?</span>alt=media<span class="syntax-all syntax-keyword">&amp;</span>token=03eede17-6a16-4d1d-8ea1-f5a896b2b4a1</code></pre>

<ol start="2">
	<li>이미지 다운로드하기</li>
</ol>

<pre><code class="code-highlighted code-swift"><span class="syntax-all syntax-keyword">class</span> <span class="syntax-all syntax-entity">ViewController</span>: UIViewController, UIImagePickerControllerDelegate, UINavigationControllerDelegate {
    <span class="syntax-all syntax-keyword">@IBOutlet</span> <span class="syntax-all syntax-keyword">weak</span> <span class="syntax-all syntax-keyword">var</span> mainImageview<span class="syntax-all syntax-keyword">:</span> UIImageView<span class="syntax-all syntax-keyword">!</span>
    <span class="syntax-all syntax-keyword">@IBOutlet</span> <span class="syntax-all syntax-keyword">weak</span> <span class="syntax-all syntax-keyword">var</span> albumButton<span class="syntax-all syntax-keyword">:</span> UIButton<span class="syntax-all syntax-keyword">!</span>
    
    <span class="syntax-all syntax-keyword">override</span> <span class="syntax-all syntax-keyword">func</span> <span class="syntax-all syntax-entity">viewDidLoad</span>() {
        <span class="syntax-all syntax-constant">super</span>.<span class="syntax-all syntax-constant">viewDidLoad</span>()
        <span class="syntax-all syntax-keyword">let</span> imageUrl <span class="syntax-all syntax-keyword">=</span> <span class="syntax-all syntax-string">&quot;https://firebasestorage.googleapis.com/v0/b/howltalk-d92b6.appspot.com/o/images%2Frivers.jpg?alt=media&amp;token=03eede17-6a16-4d1d-8ea1-f5a896b2b4a1&quot;</span>
        
	mainImageview.<span class="syntax-all syntax-constant">sd_setImage</span>(<span class="syntax-all syntax-constant">with</span>: <span class="syntax-all syntax-constant">URL</span>(<span class="syntax-all syntax-constant">string</span>: imageUrl), <span class="syntax-all syntax-constant">completed</span>: <span class="syntax-all syntax-constant">nil</span>)
    }
}</code></pre>

<h6>실행화면</h6>

<figure><img src="Screen%20Shot%202019-11-08%20at%204.33.19%20AM.png"/></figure>

<p>이렇게 이미지를 받는 것을 볼 수 있다.</p>

</body>
</html>

